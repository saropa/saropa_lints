name: Announce Release in Discussions

on:
  release:
    types: [published]

jobs:
  announce:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Extract changelog for this version
        id: changelog
        run: |
          VERSION="${{ github.event.release.tag_name }}"
          awk -v version="$VERSION" '
            BEGIN { found=0 }
            /^## / {
              if (found) exit
              if ($0 ~ version) found=1
            }
            found { print }
          ' CHANGELOG.md > section.txt
          if [ ! -s section.txt ]; then
            echo "No changelog section found for $VERSION" > section.txt
          fi
          echo 'changelog<<EOF' >> $GITHUB_OUTPUT
          cat section.txt >> $GITHUB_OUTPUT
          echo 'EOF' >> $GITHUB_OUTPUT

      - name: Post announcement to GitHub Discussions
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const release = context.payload.release;
            const repo = context.repo;
            const version = release.tag_name;
            const changelog = process.env.CHANGELOG || `No changelog found for ${version}`;
            const title = `New Release: ${version}`;
            const body = `A new version has been published!\n\n**Release:** [${version}](${release.html_url})\n\n${changelog}`;

            // Get repository ID and discussion categories via GraphQL
            const repoQuery = await github.graphql(`
              query($owner: String!, $name: String!) {
                repository(owner: $owner, name: $name) {
                  id
                  discussionCategories(first: 25) {
                    nodes {
                      id
                      name
                    }
                  }
                }
              }
            `, {
              owner: repo.owner,
              name: repo.repo
            });

            const repoId = repoQuery.repository.id;
            const categories = repoQuery.repository.discussionCategories.nodes;
            const annCategory = categories.find(c => c.name.toLowerCase() === 'announcements');

            if (!annCategory) {
              console.log('Available categories:', categories.map(c => c.name));
              throw new Error('Announcements category not found. Enable Discussions and create an "Announcements" category.');
            }

            // Create the discussion via GraphQL
            await github.graphql(`
              mutation($repoId: ID!, $categoryId: ID!, $title: String!, $body: String!) {
                createDiscussion(input: {
                  repositoryId: $repoId,
                  categoryId: $categoryId,
                  title: $title,
                  body: $body
                }) {
                  discussion {
                    url
                  }
                }
              }
            `, {
              repoId: repoId,
              categoryId: annCategory.id,
              title: title,
              body: body
            });

            console.log(`Discussion created for ${version}`);
        env:
          CHANGELOG: ${{ steps.changelog.outputs.changelog }}
