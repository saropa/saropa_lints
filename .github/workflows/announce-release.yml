name: Announce Release in Discussions

on:
  release:
    types: [published]

jobs:
  announce:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Extract changelog for this version
        id: changelog
        run: |
          VERSION="${{ github.event.release.tag_name }}"
          awk -v version="$VERSION" '
            BEGIN { found=0 }
            /^## / {
              if (found) exit
              if ($0 ~ version) found=1
            }
            found { print }
          ' CHANGELOG.md > section.txt
          if [ ! -s section.txt ]; then
            echo "No changelog section found for $VERSION" > section.txt
          fi
          echo 'changelog<<EOF' >> $GITHUB_OUTPUT
          cat section.txt >> $GITHUB_OUTPUT
          echo 'EOF' >> $GITHUB_OUTPUT

      - name: Post announcement to GitHub Discussions
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const release = context.payload.release;
            const repo = context.repo;
            const version = release.tag_name;
            const changelog = process.env.CHANGELOG || process.env.changelog || `No changelog found for ${version}`;
            const title = `New Release: ${version}`;
            const body = `A new version has been published!\n\n**Release:** [${version}](${release.html_url})\n\n${changelog}`;

            // Find the Announcements category ID
            const categories = await github.rest.discussions.listCategoriesInOrg({ org: repo.owner });
            const annCategory = categories.data.find(c => c.name.toLowerCase() === 'announcements');
            if (!annCategory) throw new Error('Announcements category not found.');

            await github.rest.discussions.create({
              owner: repo.owner,
              repo: repo.repo,
              category_id: annCategory.id,
              title,
              body
            });
        env:
          CHANGELOG: ${{ steps.changelog.outputs.changelog }}
