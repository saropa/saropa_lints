# v4.12.2 — Graceful Abort, Rerun-Safe Tracking, Config & README

**Date:** 2026-02-07
**Branch:** maintenance
**Commit:** 5f45121

---

## Problems Solved

### 1. No way to stop analysis mid-flight

Large projects (10k+ issues) had no interrupt mechanism. The custom_lint framework controls the analysis loop — we can't stop it from calling rules, but we can make rules return early.

**Solution:** `.saropa_stop` sentinel file.

- `ProgressTracker.recordFile()` checks for `.saropa_stop` in project root every 50 new files
- When found: sets `_abortRequested` flag, deletes the file, writes partial report immediately via `AnalysisReporter.writeNow()`
- `SaropaLintRule.run()` returns early when `_abortRequested` is true
- Hint shown in stderr when 500-issue limit is reached

### 2. File re-analysis corrupted counts

When a file was re-analyzed within the same session (user saves during analysis), violations were double-counted. `ImpactTracker` appended new violations without clearing old ones. `ProgressTracker` incremented counts without subtracting previous values.

**Solution:** Per-file tracking maps + clearing on re-analysis.

- Added `_issuesByFileBySeverity` and `_issuesByFileByRule` maps
- `recordFile()` detects re-analysis via `!wasNew && path != _currentFile`
- `_clearFileData()` subtracts old severity/rule/file counts using `max(0, ...)` guards
- `ImpactTracker.removeViolationsForFile()` removes stale violation records
- `_limitReached` is recalculated (may un-reach if enough were cleared)

### 3. No config for output mode

Users had no way to skip the Problems tab and send everything to the report file only.

**Solution:** `output` setting in yaml and env var.

- `analysis_options_custom.yaml`: `output: both` (default) or `output: file`
- Env var override: `SAROPA_LINTS_OUTPUT=file dart run custom_lint`
- `shouldReportToProblems` getter combines `!_fileOnly && !_limitReached && !_abortRequested`
- Replaces all 3 `!ProgressTracker.isLimitReached` checks in `SaropaDiagnosticReporter`

### 4. Config loading read the yaml file twice

`_loadMaxIssuesConfig()` and `_loadOutputConfig()` each independently read `analysis_options_custom.yaml`.

**Solution:** Consolidated into single `_loadAnalysisConfig()` that reads the file once, parses both `max_issues` and `output` with consistent regex patterns (`^key`, `multiLine: true`).

### 5. README Quick Start was buried

Quick Start was at line 187, after ~185 lines of marketing. New users had no idea what to do.

**Solution:** Moved Quick Start to line 30 (right after badges). Three clear steps:

1. Install & initialize (`dart pub add` + `dart run saropa_lints:init`)
2. Review settings (`analysis_options_custom.yaml` — platforms, packages, max_issues, output)
3. Run analysis (`dart run custom_lint`)

Added "Where do my issues go?" table making it explicit that the report file always has ALL issues uncapped.

---

## Bugs Found & Fixed During Review

| Bug | File | Fix |
|-----|------|-----|
| `_ruleSeverities` removed when one file's count hits 0, breaking severity labels for other files still using that rule | `saropa_lint_rule.dart` | Keep `_ruleSeverities` entries (stale entries are harmless) |
| `SAROPA_LINTS_OUTPUT=both` did nothing but skipped yaml fallback | `saropa_lints.dart` | Explicitly handle both `file` and `both` values |
| `max_issues` regex had no `^` anchor — could match indented yaml keys | `saropa_lints.dart` | Both regexes now use `^` with `multiLine: true` |

---

## Files Changed

| File | What changed |
|------|-------------|
| `lib/src/saropa_lint_rule.dart` | ProgressTracker: abort flag, per-file maps, `_clearFileData()`, `_handleNewFile()`, `_trackByFileAndRule()`, `shouldReportToProblems`. ImpactTracker: `removeViolationsForFile()`. SaropaLintRule: abort early return. SaropaDiagnosticReporter: 3x `shouldReportToProblems` |
| `lib/src/report/analysis_reporter.dart` | Added `projectRoot` getter, `writeNow()` method |
| `lib/saropa_lints.dart` | Consolidated `_loadAnalysisConfig()`, added `_logActiveConfig()` |
| `bin/init.dart` | Updated yaml template: default 1000→500, added `output: both`, detailed comments |
| `README.md` | Quick Start moved to top, old duplicate removed, "Where do my issues go?" table |
| `CHANGELOG.md` | 3 entries: graceful abort, file-only output, re-analysis fix |

---

## Verification

- `dart analyze` — no issues
- `dart test` — 143/143 passed
- `dart format` — 0 files changed
